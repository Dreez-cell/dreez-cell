<!doctype html>


  
  
  ConnectSphere Widget
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism-tomorrow.min.css" />
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-html.min.js"></script>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --text-dark: #0f172a;
      --text-muted: #475569;
      --border: #d1d5db;
      --background: #f8fafc;
      --error: #dc2626;
    }
    #firebaseWidgetApp {
      max-width: 960px;
      margin: 40px auto;
      padding: 32px 16px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
      border-radius: 32px;
      box-shadow: 0 16px 48px rgba(15,23,42,0.12);
    }
    .btn {
      background: linear-gradient(90deg, #e2e8f0 0%, #e5e7eb 100%);
      border: none;
      padding: 10px 24px;
      border-radius: 9999px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.1em;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn:hover { background: linear-gradient(90deg, #d1d5db 0%, #d4d4d8 100%); transform: scale(1.02); }
    .btn.primary { background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%); color: #fff; }
    .btn.primary:hover { background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary) 100%); }
    .btn.danger { background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); color: #fff; }
    .btn.danger:hover { background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%); }
    .btn:active { transform: scale(0.98); }
    .follow-btn[followed] { background: linear-gradient(90deg, #e2e8f0 0%, #e5e7eb 100%); color: var(--text-dark); }
    .follow-btn[followed]:hover { background: linear-gradient(90deg, #d1d5db 0%, #d4d4d8 100%); }
    #profileCard { border-radius: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); background: #fff; margin-bottom: 24px; overflow: hidden; }
    .profile-banner { width: 100%; height: 160px; background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%); }
    .profile-banner img { width: 100%; height: 160px; object-fit: cover; }
    .profile-avatar { width: 104px; height: 104px; border-radius: 50%; border: 5px solid #fff; position: absolute; left: 24px; top: 104px; object-fit: cover; z-index: 2; background: var(--background); }
    .profile-body { padding: 72px 24px 24px; }
    .profile-info h3 { margin: 0; font-size: 1.6em; font-weight: 900; color: var(--text-dark); }
    .profile-handle { color: var(--text-muted); margin-top: 4px; font-size: 1.15em; }
    .profile-bio { margin: 16px 0 12px; color: var(--text-dark); font-size: 1.1em; line-height: 1.6; }
    .profile-links a { text-decoration: none; font-size: 1em; color: var(--primary); background: #eff6ff; padding: 8px 16px; border-radius: 9999px; font-weight: 600; }
    .profile-links a:hover { background: #dbeafe; }
    .profile-meta { display: flex; gap: 24px; margin-top: 12px; font-size: 1.15em; color: var(--text-dark); }
    .profile-meta span { cursor: pointer; font-weight: 600; }
    .profile-joined { color: var(--text-muted); font-size: 1em; margin-top: 8px; }
    .profile-edit-btn, .follow-btn { float: right; margin-top: -48px; background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%); color: #fff; border: none; border-radius: 9999px; padding: 10px 24px; font-weight: 700; }
    .profile-edit-btn:hover, .follow-btn:hover { background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary) 100%); }
    .post-card { background: #fff; border-radius: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); margin-bottom: 24px; padding: 24px; display: flex; gap: 16px; position: relative; }
    .post-card img, .post-card video, .post-card audio { border-radius: 16px; max-width: 100%; max-height: 280px; }
    .post-card video[autoplay] { width: 100%; }
    .post-left img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; cursor: pointer; }
    .post-main { flex: 1; }
    .post-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .post-header strong { font-size: 1.15em; cursor: pointer; font-weight: 800; }
    .post-header .profile-handle { font-size: 1em; }
    .post-content { margin: 12px 0; line-height: 1.6; font-size: 1.15em; }
    .post-media { display: flex; gap: 12px; flex-wrap: wrap; }
    .post-actions { display: flex; gap: 20px; margin-top: 12px; }
    .meta-pill { background: var(--background); border: none; border-radius: 9999px; padding: 8px 20px; font-size: 1em; cursor: pointer; }
    .meta-pill:hover { background: #eff6ff; color: var(--primary); }
    .like-btn[liked] { background: #fee2e2; color: #dc2626; }
    .repost-btn[reposted] { background: #d1fae5; color: #10b981; }
    .quote-btn[quoted] { background: #eff6ff; color: var(--primary); }
    .share-btn[shared] { background: #eff6ff; color: var(--primary); }
    .quote-link { color: var(--primary); font-weight: 600; text-decoration: none; }
    .quote-link:hover { text-decoration: underline; }
    .reply-area { margin-top: 12px; }
    .reply-card { background: #f9fafb; border-radius: 16px; padding: 12px 16px; margin: 8px 0; }
    .reply-thread { margin-left: 48px; border-left: 2px solid #e5e7eb; padding-left: 16px; position: relative; transition: opacity 0.3s ease, transform 0.3s ease; }
    .post-card.reply-thread::before { content: ''; position: absolute; left: -2px; top: 0; height: 100%; width: 2px; background: #e5e7eb; }
    .reply-thread-collapsed { display: none; }
    .reply-toggle-btn { background: #eff6ff; color: var(--primary); border: none; border-radius: 9999px; padding: 8px 20px; margin-bottom: 12px; cursor: pointer; font-size: 0.95em; transition: background 0.2s ease; }
    .reply-toggle-btn:hover { background: #dbeafe; }
    #mediaPreview img, #mediaPreview video, #mediaPreview audio { max-width: 72px; max-height: 72px; border-radius: 12px; }
    a.hashtag { color: var(--primary); font-weight: 700; }
    a.hashtag:hover { text-decoration: underline; }
    a.mention { color: var(--primary); font-weight: 600; }
    .blue-tick::after { content: '‚úî'; color: #3b82f6; font-size: 0.9em; margin-left: 4px; }
    #errorContainer { display: none; background: #fee2e2; color: #dc2626; padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; text-align: center; font-size: 1em; }
    input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #d1d5db; font-size: 1.1em; margin-bottom: 12px; }
    textarea { resize: vertical; min-height: 100px; }
    @media (max-width: 768px) {
      #firebaseWidgetApp > div { flex-direction: column; }
      #profileCard, #authCard, #searchTrendingCard, #suggestedUsersCard, #trendingMediaCard, #profileEditCard, #adminPanel, #communityCard, #notificationsCard { max-width: 100%; }
      .profile-avatar { width: 88px; height: 88px; top: 96px; }
      .profile-banner { height: 140px; }
      .reply-thread { margin-left: 24px; }
    }
  </style>


  <div id="firebaseWidgetApp">
    <div id="errorContainer"></div>
    <div style="display:flex;gap:32px;flex-wrap:wrap;align-items:flex-start;">
      <div style="flex:1 1 360px;max-width:360px;min-width:280px;">
        <div id="profileCard" style="display:none;"></div>
        <div id="authCard" style="background:#fff;border-radius:24px;box-shadow:0 8px 24px rgba(0,0,0,0.1);padding:24px;margin-bottom:24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h3 style="margin:0 0 4px 0;font-weight:900;font-size:1.5em;letter-spacing:-0.02em;color:#0f172a;">ConnectSphere</h3>
              <div id="welcomeMsg" style="color:#475569;font-size:1.1em;"></div>
            </div>
            <div>
              <button id="signInBtn" class="btn primary">Sign In</button>
              <button id="signOutBtn" class="btn danger" style="display:none;">Sign Out</button>
            </div>
          </div>
        </div>
        <div id="searchTrendingCard" style="background:#fff;border-radius:24px;box-shadow:0 4px 16px rgba(0,0,0,0.1);padding:24px;margin-bottom:24px;">
          <div style="margin-bottom:16px;">
            <input id="searchBar" type="text" placeholder="Search users or hashtags..." />
            <div id="searchResults" style="margin-top:8px;"></div>
          </div>
          <div id="trendingSection">
            <h4 style="margin:0 0 12px 0;font-weight:800;color:#0f172a;">Trending</h4>
            <div id="trendingHashtagsCard"></div>
          </div>
        </div>
        <div id="suggestedUsersCard" style="background:#fff;border-radius:24px;box-shadow:0 4px 16px rgba(0,0,0,0.1);padding:24px;margin-bottom:24px;display:none;"></div>
        <div id="trendingMediaCard" style="background:#fff;border-radius:24px;box-shadow:0 4px 16px rgba(0,0,0,0.1);padding:24px;margin-bottom:24px;">
          <h4 style="margin:0 0 12px 0;font-weight:800;color:#0f172a;">Trending Media</h4>
          <div id="trendingMediaContent"></div>
        </div>
        <div id="profileEditCard" style="display:none;background:#fff;border-radius:24px;box-shadow:0 4px 16px rgba(0,0,0,0.1);padding:24px;">
          <h4 style="font-weight:800;color:#0f172a;margin:0 0 16px 0;">Edit Profile</h4>
          <input id="editDisplayName" type="text" placeholder="Display Name" maxlength="32" />
          <input id="editHandle" type="text" placeholder="@handle" maxlength="18" />
          <textarea id="editBio" placeholder="Bio (max 160)" maxlength="160"></textarea>
          <input id="editLinks" type="text" placeholder="Links (comma separated)" />
          <label style="font-size:1em;display:block;margin-bottom:8px;color:#475569;">Avatar <input id="editAvatarInput" type="file" accept="image/*" /></label>
          <label style="font-size:1em;display:block;margin-bottom:8px;color:#475569;">Banner <input id="editBannerInput" type="file" accept="image/*" /></label>
          <div id="artistSongsSection" style="margin-top:16px;">
            <h4 style="margin:0 0 12px 0;font-weight:800;color:#0f172a;">Manage Songs (Max 5)</h4>
            <div id="currentSongs"></div>
            <label style="font-size:1em;display:block;margin-bottom:8px;color:#475569;">Add Song <input id="songInput" type="file" accept="audio/*" /></label>
            <input id="songTitle" type="text" placeholder="Song Title" maxlength="50" />
            <select id="songGenre">
              <option value="" />Select Genre
              <option value="pop" />Pop
              <option value="rock" />Rock
              <option value="hiphop" />Hip-Hop
              <option value="jazz" />Jazz
              <option value="electronic" />Electronic
              <option value="classical" />Classical
            </select>
          </div>
          <div style="text-align:right;margin-top:12px;">
            <button id="cancelProfileEdit" class="btn">Cancel</button>
            <button id="saveProfileBtn" class="btn primary">Save</button>
          </div>
        </div>
        <div id="adminPanel" style="display:none;background:#fff;border-radius:24px;box-shadow:0 4px 16px rgba(0,0,0,0.1);padding:24px;margin-bottom:24px;">
          <h4 style="font-weight:800;color:#0f172a;margin:0 0 16px 0;">Admin Panel</h4>
          <div style="margin-bottom:12px;">
            <input id="adminSearchUser" type="text" placeholder="Search user by handle..." />
            <button id="adminSearchBtn" class="btn primary" style="margin-top:8px;">Search</button>
          </div>
          <div id="adminUserResults"></div>
          <h5 style="margin:16px 0 8px 0;font-weight:700;color:#0f172a;">Moderate Posts</h5>
          <div id="adminPostList"></div>
        </div>
        <div id="communityCard" style="background:#fff;border-radius:24px;box-shadow:0 4px 16px rgba(0,0,0,0.1);padding:24px;margin-bottom:24px;display:none;">
          <h4 style="font-weight:800;color:#0f172a;margin:0 0 16px 0;">Communities</h4>
          <button id="createCommunityBtn" class="btn primary">Create Community</button>
          <div id="communityList"></div>
        </div>
      </div>
      <div style="flex:3 1 480px;min-width:320px;">
        <div id="postWidget" style="display:none;background:#fff;border-radius:24px;box-shadow:0 4px 16px rgba(0,0,0,0.1);padding:24px;margin-bottom:24px;">
          <textarea id="blogContent" maxlength="500" placeholder="What's on your mind? (e.g., :smile: for emojis, #hashtag, @mention, ```lang code```)"></textarea>
          <div style="margin:12px 0;">
            <input type="file" id="mediaInput" accept="image/jpeg,image/png,video/mp4,video/webm,audio/mpeg,audio/mp3" multiple />
            <div id="mediaPreview" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <small id="charCount" style="color:#6b7280;font-size:0.95em;">0/500</small>
            <button id="postBlogBtn" class="btn primary">Post</button>
          </div>
        </div>
        <div id="notificationsCard" style="background:#fff;border-radius:24px;box-shadow:0 4px 16px rgba(0,0,0,0.1);padding:24px;margin-bottom:24px;display:none;">
          <h4 style="margin:0 0 12px 0;font-weight:800;color:#0f172a;">Notifications</h4>
          <div id="notificationsContent"></div>
        </div>
        <div style="display:flex;gap:12px;margin-bottom:16px;">
          <button id="forYouFeedBtn" class="btn primary">For You</button>
          <button id="followingFeedBtn" class="btn">Following</button>
          <button id="profileBtn" class="btn" style="display:none;">Profile</button>
          <button id="notificationsBtn" class="btn" style="display:none;">Notifications</button>
          <button id="adminPanelBtn" class="btn" style="display:none;">Admin Panel</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <h4 id="feedTitle" style="margin:0;font-size:1.4em;letter-spacing:-0.02em;font-weight:900;color:#0f172a;">Feed</h4>
          <button id="backToFeedBtn" class="btn" style="display:none;">Back</button>
        </div>
        <div id="feedEmptyMsg" style="text-align:center;color:#94a3b8;margin:24px 0;display:none;font-size:1.1em;">No posts yet. Start the conversation!</div>
        <div id="blogFeedContainer"></div>
      </div>
    </div>
  </div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC5lso_DXjw9ft--0PhkJHsaKLNH7ravAc",
      authDomain: "twitter-clone-ccrsxx-2513a.firebaseapp.com",
      projectId: "twitter-clone-ccrsxx-2513a",
      storageBucket: "twitter-clone-ccrsxx-2513a.firebasestorage.app",
      messagingSenderId: "190229673027",
      appId: "1:190229673027:web:9e5a4670a0269c7e8150f6",
      measurementId: "G-0TNQSSVCYN"
    };

    // Initialize Firebase
    if (!window.firebase || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      firebase.analytics = firebase.analytics() || {
        logEvent: (eventName, params) => console.log(`Analytics event: ${eventName}`, params)
      };
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('https://www.googleapis.com/auth/drive.file');

    // Google Drive Configuration
    const widgetFolderName = "BloggerWidgetMedia";
    let gapiLoaded = false;

    function loadGapi() {
      return new Promise((resolve, reject) => {
        if (gapiLoaded) return resolve();
        gapi.load('client:auth2', () => {
          gapi.client.init({
            apiKey: firebaseConfig.apiKey,
            clientId: '1234567890-abc123def456.apps.googleusercontent.com
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            scope: 'https://www.googleapis.com/auth/drive.file'
          }).then(() => {
            gapiLoaded = true;
            resolve();
          }).catch(e => reject(new Error('Failed to initialize Google Drive API: ' + (e.error?.message || 'Unknown error'))));
        });
      });
    }

    function ensureUserFolder(userId) {
      return new Promise((resolve, reject) => {
        if (!gapiLoaded || !auth.currentUser) return reject(new Error('Google Drive not initialized or user not signed in'));
        auth.currentUser.getIdToken().then(token => {
          gapi.client.drive.files.list({
            q: `name='${widgetFolderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name)',
            spaces: 'drive'
          }).then(response => {
            const files = response.result.files;
            let rootFolderId;
            if (files?.length) {
              rootFolderId = files[0].id;
            } else {
              return gapi.client.drive.files.create({
                resource: { name: widgetFolderName, mimeType: 'application/vnd.google-apps.folder' },
                fields: 'id'
              }).then(response => {
                rootFolderId = response.result.id;
                return shareFolderWithServiceAccount(rootFolderId);
              });
            }
            return Promise.resolve(rootFolderId);
          }).then(rootFolderId => {
            gapi.client.drive.files.list({
              q: `name='${userId}' and '${rootFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
              fields: 'files(id, name)',
              spaces: 'drive'
            }).then(response => {
              const files = response.result.files;
              if (files?.length) {
                resolve(files[0].id);
              } else {
                gapi.client.drive.files.create({
                  resource: { name: userId, mimeType: 'application/vnd.google-apps.folder', parents: [rootFolderId] },
                  fields: 'id'
                }).then(response => resolve(response.result.id)).catch(e => reject(new Error('Failed to create user folder: ' + (e.error?.message || 'Unknown error'))));
              }
            });
          }).catch(e => reject(new Error('Failed to list folders: ' + (e.error?.message || 'Unknown error'))));
        }).catch(e => reject(new Error('Failed to get auth token: ' + (e.message || 'Unknown error'))));
      });
    }

    function shareFolderWithServiceAccount(folderId) {
      return gapi.client.drive.permissions.create({
        fileId: folderId,
        resource: {
          role: 'writer',
          type: 'user',
          emailAddress: 'google-drive-843@twitter-clone-ccrsxx-2513a.iam.gserviceaccount.com'
        }
      }).then(() => {}).catch(e => { throw new Error('Failed to share folder: ' + (e.error?.message || 'Unknown error')); });
    }

    function uploadToDrive(file, fileName, userId, retries = 2) {
      if (!file.type.match(/image\/(jpeg|png)|video\/(mp4|webm)|audio\/(mpeg|mp3)/)) throw new Error('Unsupported file type. Use JPEG, PNG, MP4, WebM, or MP3.');
      if (file.size > 10 * 1024 * 1024) throw new Error('File size exceeds 10MB limit.');
      return ensureUserFolder(userId).then(folderId => {
        const metadata = { name: fileName, mimeType: file.type, parents: [folderId] };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);
        return auth.currentUser.getIdToken().then(token => {
          return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: { Authorization: 'Bearer ' + token },
            body: form
          }).then(response => {
            if (!response.ok) return response.json().then(err => { throw new Error(`Upload failed: HTTP ${response.status} - ${err.error?.message || 'Unknown error'}`); });
            return response.json();
          }).then(data => {
            return gapi.client.drive.permissions.create({
              fileId: data.id,
              resource: { role: 'reader', type: 'anyone' }
            }).then(() => {
              return gapi.client.drive.files.get({
                fileId: data.id,
                fields: 'id, webViewLink'
              }).then(response => ({ id: response.result.id, url: response.result.webViewLink }));
            });
          }).catch(e => {
            if (retries > 0 && (e.message.includes('429') || e.message.includes('Quota exceeded'))) {
              return new Promise(resolve => setTimeout(resolve, 2000)).then(() => uploadToDrive(file, fileName, userId, retries - 1));
            }
            throw e;
          });
        });
      });
    }

    function deleteFromDrive(fileId) {
      if (!gapiLoaded || !auth.currentUser) return Promise.reject(new Error('Google Drive not initialized or user not signed in'));
      return auth.currentUser.getIdToken().then(token => {
        return gapi.client.drive.files.delete({ fileId }).then(() => {
          firebase.analytics().logEvent('delete_file_drive', { file_id: fileId });
        }).catch(e => { throw new Error('Failed to delete file: ' + (e.error?.message || 'Unknown error')); });
      });
    }

    function showError(message) {
      const errorContainer = document.getElementById('errorContainer');
      errorContainer.textContent = message;
      errorContainer.style.display = 'block';
      setTimeout(() => { errorContainer.style.display = 'none'; }, 5000);
      firebase.analytics().logEvent('error', { message });
    }

    const emojiMap = {
      smile: "üòÑ", heart: "‚ù§Ô∏è", thumbsup: "üëç", fire: "üî•", clap: "üëè",
      joy: "üòÇ", sob: "üò≠", scream: "üò±", cool: "üòé", grin: "üòÅ",
      wink: "üòâ", cry: "üò¢", angry: "üò†", pray: "üôè", star: "‚≠ê",
      rocket: "üöÄ", sparkles: "‚ú®", thinking: "ü§î", ok: "üëå", party: "üéâ"
    };

    function emojify(str) {
      return (str || "").replace(/:([a-zA-Z0-9_+-]+):/g, (m, name) => emojiMap[name] || m);
    }

    function hashtagify(str) {
      return (str || "").replace(/(^|\s)#(\w+)/g, '$1<a href="#" class="hashtag" data-tag="$2">#$2</a>');
    }

    function mentionify(str) {
      return (str || "").replace(/(^|\s)@(\w+)/g, '$1<a href="#" class="mention" data-mention="$2">@$2</a>');
    }

    function formatContent(str) {
      if (!str) return "";
      let formatted = emojify(str);
      formatted = hashtagify(formatted);
      formatted = mentionify(formatted);
      formatted = formatted.replace(/```(\w+)?\n([\s\S]*?)\n```/g, (match, lang, code) => {
        const language = lang || 'text';
        return `<pre><code class="language-${language}">${code}</code></pre>`;
      });
      return formatted;
    }

    function updateCharCount(textarea, charCountElement) {
      charCountElement.textContent = `${textarea.value.length}/500`;
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function showReplyBox(postId, parentReplyId = null, replyTo = null) {
      const replyArea = document.getElementById(`replyArea-${postId}`);
      if (!replyArea) return;
      const existingBox = replyArea.querySelector('.reply-card');
      if (existingBox) {
        existingBox.remove();
        return;
      }
      const replyCard = document.createElement('div');
      replyCard.className = 'reply-card';
      replyCard.innerHTML = `
        <div style="font-size:0.95em;color:#475569;margin-bottom:8px;">
          ${replyTo ? `Replying to @${replyTo}` : 'Write a reply...'}
        </div>
        <textarea class="reply-input" maxlength="500" style="width:100%;resize:vertical;min-height:80px;font-size:1rem;padding:12px;border-radius:12px;border:1px solid #d1d5db;" placeholder="Your reply..."></textarea>
        <div style="margin:12px 0;">
          <input type="file" class="reply-media-input" accept="image/jpeg,image/png,video/mp4,video/webm,audio/mpeg,audio/mp3" multiple style="margin-bottom:8px;" />
          <div class="reply-media-preview" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;"></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <small class="reply-char-count" style="color:#6b7280;font-size:0.95em;">0/500</small>
          <button class="btn primary reply-submit-btn">Reply</button>
        </div>
      `;
      replyArea.appendChild(replyCard);
      const replyInput = replyCard.querySelector('.reply-input');
      const replyMediaInput = replyCard.querySelector('.reply-media-input');
      const replyMediaPreview = replyCard.querySelector('.reply-media-preview');
      const replyCharCount = replyCard.querySelector('.reply-char-count');
      const replySubmitBtn = replyCard.querySelector('.reply-submit-btn');

      updateCharCount(replyInput, replyCharCount);
      replyInput.addEventListener('input', () => updateCharCount(replyInput, replyCharCount));

      replyMediaInput.addEventListener('change', () => {
        replyMediaPreview.innerHTML = '';
        Array.from(replyMediaInput.files).forEach(file => {
          const url = URL.createObjectURL(file);
          let element;
          if (file.type.startsWith('image/')) element = document.createElement('img');
          else if (file.type.startsWith('video/')) { element = document.createElement('video'); element.controls = true; }
          else if (file.type.startsWith('audio/')) { element = document.createElement('audio'); element.controls = true; }
          element.src = url;
          replyMediaPreview.appendChild(element);
        });
      });

      replySubmitBtn.addEventListener('click', async () => {
        if (!currentUser || !currentUser.uid) return showError('Please sign in to reply.');
        const content = replyInput.value.trim();
        if (!content && !replyMediaInput.files.length) return showError('Reply cannot be empty.');
        try {
          const mediaUrls = [];
          for (const file of replyMediaInput.files) {
            const fileName = `${Date.now()}_${file.name}`;
            const uploadResult = await uploadToDrive(file, fileName, currentUser.uid);
            mediaUrls.push({ url: uploadResult.url, id: uploadResult.id, type: file.type });
          }
          const replyData = {
            content,
            media: mediaUrls,
            userId: currentUser.uid,
            userHandle: currentUser.handle,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            parent: postId,
            replyTo: parentReplyId || postId,
            likes: [],
            reposts: [],
            hashtags: content.match(/(^|\s)#(\w+)/g)?.map(tag => tag.trim().slice(1).toLowerCase()) || [],
            communityId: currentCommunityId
          };
          await db.collection('posts').add(replyData);
          replyCard.remove();
          firebase.analytics().logEvent('post_reply', { post_id: postId, has_media: mediaUrls.length > 0 });
          if (postId !== parentReplyId) {
            const post = await db.collection('posts').doc(postId).get();
            if (post.exists && post.data().userId !== currentUser.uid) {
              await db.collection('notifications').add({
                userId: post.data().userId,
                type: 'comment',
                postId,
                fromUserId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }
        } catch (e) {
          showError('Failed to post reply: ' + (e.message || 'Unknown error'));
        }
      });
    }

    async function renderPost(post, userData, level = 0, communityId = null) {
      const postId = post.id;
      const isReply = !!post.parent;
      const postDiv = document.createElement('div');
      postDiv.className = `post-card${isReply ? ' reply-thread' : ''}`;
      postDiv.style.marginLeft = `${level * 48}px`;
      postDiv.setAttribute('data-post-id', postId);
      if (isReply) postDiv.setAttribute('data-parent', post.parent);
      let mediaHtml = '';
      if (post.media?.length) {
        mediaHtml = '<div class="post-media">';
        post.media.forEach(media => {
          if (media.type.startsWith('image/')) mediaHtml += `<img src="${media.url}" alt="Post media" />`;
          else if (media.type.startsWith('video/')) mediaHtml += `<video src="${media.url}" controls autoplay muted></video>`;
          else if (media.type.startsWith('audio/')) mediaHtml += `<audio src="${media.url}" controls></audio>`;
        });
        mediaHtml += '</div>';
      }
      const replyTo = post.replyTo && post.replyTo !== post.parent ? (await db.collection('posts').doc(post.replyTo).get()).data()?.userHandle : null;
      postDiv.innerHTML = `
        <div class="post-left">
          <img src="${userData.avatar || 'https://via.placeholder.com/56'}" alt="Avatar" />
        </div>
        <div class="post-main">
          <div class="post-header">
            <strong ${userData.isVerified ? 'class="blue-tick"' : ''}>${userData.displayName || 'Anonymous'}</strong>
            <span class="profile-handle">@${userData.handle || 'user'}</span>
            <span>¬∑ ${new Date(post.createdAt?.toDate() || Date.now()).toLocaleString()}</span>
          </div>
          ${post.replyTo && replyTo ? `<div style="color:#475569;font-size:0.95em;margin-bottom:8px;">Replying to @${replyTo}</div>` : ''}
          <div class="post-content">${formatContent(post.content)}${post.quotePostId ? `<div style="margin-top:8px;"><a href="#" class="quote-link" data-post-id="${post.quotePostId}">View quoted post</a></div>` : ''}</div>
          ${mediaHtml}
          <div class="post-actions">
            <button class="meta-pill like-btn" data-post-id="${postId}" ${post.likes?.includes(currentUser?.uid) ? 'liked' : ''}>‚ù§Ô∏è ${post.likes?.length || 0}</button>
            <button class="meta-pill reply-btn" data-post-id="${postId}" data-reply-to="${userData.handle || 'user'}">üí¨ Reply</button>
            <button class="meta-pill repost-btn" data-post-id="${postId}" ${post.reposts?.includes(currentUser?.uid) ? 'reposted' : ''}>üîÑ ${post.reposts?.length || 0}</button>
            <button class="meta-pill quote-btn" data-post-id="${postId}" data-user-handle="${userData.handle || 'user'}">üìú Quote</button>
            <button class="meta-pill share-btn" data-post-id="${postId}">üîó Share</button>
            ${currentUser?.uid === userData.uid || currentUser?.isAdmin ? `<button class="meta-pill delete-btn" data-post-id="${postId}">üóëÔ∏è Delete</button>` : ''}
          </div>
          <div id="replyArea-${postId}" class="reply-area"></div>
          ${level > 0 ? `<button class="reply-toggle-btn" data-parent="${post.parent}">Show Replies</button>` : ''}
        </div>
      `;
      const parentReplies = isReply ? document.querySelector(`[data-post-id="${post.parent}"] .reply-area`) : null;
      (parentReplies || feedContainer).appendChild(postDiv);
      Prism.highlightAllUnder(postDiv);
      postDiv.querySelectorAll('.hashtag').forEach(tag => {
        tag.addEventListener('click', e => {
          e.preventDefault();
          document.getElementById('searchBar').value = `#${tag.dataset.tag}`;
          searchContent();
        });
      });
      postDiv.querySelectorAll('.mention').forEach(mention => {
        mention.addEventListener('click', e => {
          e.preventDefault();
          document.getElementById('searchBar').value = `@${mention.dataset.mention}`;
          searchContent();
        });
      });
      postDiv.querySelectorAll('.quote-link').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          showPost(link.dataset.postId);
        });
      });
      postDiv.querySelector('.post-left img').addEventListener('click', () => showProfile(userData.uid));
      postDiv.querySelector('.post-header strong').addEventListener('click', () => showProfile(userData.uid));
      const likeBtn = postDiv.querySelector('.like-btn');
      likeBtn.addEventListener('click', debounce(async () => {
        if (!currentUser || !currentUser.uid) return showError('Please sign in to like.');
        try {
          const postRef = db.collection('posts').doc(postId);
          const postSnap = await postRef.get();
          if (!postSnap.exists) return showError('Post no longer exists.');
          const postData = postSnap.data();
          const likes = postData.likes || [];
          if (likes.includes(currentUser.uid)) {
            await postRef.update({ likes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
          } else {
            await postRef.update({ likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
            if (userData.uid !== currentUser.uid) {
              await db.collection('notifications').add({
                userId: userData.uid,
                type: 'like',
                postId,
                fromUserId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }
          firebase.analytics().logEvent('like_post', { post_id: postId });
        } catch (e) {
          showError(`Failed to like post: ${e.message || 'Unknown error'}`);
        }
      }, 300));
      const replyBtn = postDiv.querySelector('.reply-btn');
      replyBtn.addEventListener('click', () => showReplyBox(postId, isReply ? postId : null, replyBtn.dataset.replyTo));
      const repostBtn = postDiv.querySelector('.repost-btn');
      repostBtn.addEventListener('click', debounce(async () => {
        if (!currentUser || !currentUser.uid) return showError('Please sign in to repost.');
        try {
          const postRef = db.collection('posts').doc(postId);
          const postSnap = await postRef.get();
          if (!postSnap.exists) return showError('Post no longer exists.');
          const postData = postSnap.data();
          const reposts = postData.reposts || [];
          if (reposts.includes(currentUser.uid)) {
            await postRef.update({ reposts: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
          } else {
            await postRef.update({ reposts: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
            if (userData.uid !== currentUser.uid) {
              await db.collection('notifications').add({
                userId: userData.uid,
                type: 'repost',
                postId,
                fromUserId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }
          firebase.analytics().logEvent('repost_post', { post_id: postId });
        } catch (e) {
          showError(`Failed to repost: ${e.message || 'Unknown error'}`);
        }
      }, 300));
      const quoteBtn = postDiv.querySelector('.quote-btn');
      quoteBtn.addEventListener('click', () => {
        if (!currentUser) return showError('Please sign in to quote.');
        const quoteText = `Quoting @${quoteBtn.dataset.userHandle}: ${post.content}`;
        document.getElementById('blogContent').value = `${quoteText}\n\n[Quote Post ID: ${postId}]`;
        document.getElementById('postWidget').scrollIntoView({ behavior: 'smooth' });
      });
      const shareBtn = postDiv.querySelector('.share-btn');
      shareBtn.addEventListener('click', async () => {
        const postUrl = `${window.location.href}#post-${postId}`;
        try {
          if (navigator.share) {
            await navigator.share({ title: `Post by @${userData.handle || 'user'}`, text: post.content, url: postUrl });
            firebase.analytics().logEvent('share_post_web', { post_id: postId });
          } else {
            await navigator.clipboard.writeText(postUrl);
            showError('Link copied to clipboard!');
            firebase.analytics().logEvent('share_post_clipboard', { post_id: postId });
          }
        } catch (e) {
          showError('Failed to share post: ' + (e.message || 'Unknown error'));
        }
      });
      const deleteBtn = postDiv.querySelector('.delete-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          if (confirm('Delete this post?')) {
            try {
              if (post.media?.length) {
                for (const media of post.media) {
                  await deleteFromDrive(media.id);
                }
              }
              await db.collection('posts').doc(postId).delete();
              firebase.analytics().logEvent('delete_post', { post_id: postId });
            } catch (e) {
              showError('Failed to delete post: ' + (e.message || 'Unknown error'));
            }
          }
        });
      }
      const toggleBtn = postDiv.querySelector('.reply-toggle-btn');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          const replies = document.querySelectorAll(`[data-parent="${post.parent}"]`);
          replies.forEach(reply => reply.classList.toggle('reply-thread-collapsed'));
          toggleBtn.textContent = replies[0]?.classList.contains('reply-thread-collapsed') ? 'Show Replies' : 'Hide Replies';
        });
      }
    }

    async function renderThread(post, userData, level = 0, communityId = null) {
      await renderPost(post, userData, level, communityId);
      const replies = await db.collection('posts').where('parent', '==', post.id).orderBy('createdAt', 'desc').get();
      for (const reply of replies.docs) {
        const replyData = reply.data();
        const replyUser = await db.collection('users').doc(replyData.userId).get();
        if (replyUser.exists) {
          await renderThread({ id: reply.id, ...replyData }, replyUser.data(), level + 1, communityId);
        }
      }
    }

    let currentUser = null, viewingProfileUserId = null, feedUnsub = null, currentCommunityId = null;
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const postWidget = document.getElementById('postWidget');
    const welcomeMsg = document.getElementById('welcomeMsg');
    const feedContainer = document.getElementById('blogFeedContainer');
    const mediaInput = document.getElementById('mediaInput');
    const mediaPreview = document.getElementById('mediaPreview');
    const blogContent = document.getElementById('blogContent');
    const charCount = document.getElementById('charCount');
    const profileCard = document.getElementById('profileCard');
    const profileEditCard = document.getElementById('profileEditCard');
    const backToFeedBtn = document.getElementById('backToFeedBtn');
    const feedTitle = document.getElementById('feedTitle');
    const profileBtn = document.getElementById('profileBtn');
    const adminPanelBtn = document.getElementById('adminPanelBtn');
    const notificationsBtn = document.getElementById('notificationsBtn');
    const communityCard = document.getElementById('communityCard');
    const createCommunityBtn = document.getElementById('createCommunityBtn');
    const communityList = document.getElementById('communityList');
    const notificationsCard = document.getElementById('notificationsCard');
    const suggestedUsersCard = document.getElementById('suggestedUsersCard');
    const trendingMediaCard = document.getElementById('trendingMediaCard');

    function startFeedListener(type = 'forYou', userId = null, communityId = null) {
      if (feedUnsub) feedUnsub();
      feedContainer.innerHTML = '';
      document.getElementById('feedEmptyMsg').style.display = 'none';
      currentCommunityId = communityId;
      let query = db.collection('posts').orderBy('createdAt', 'desc').limit(20);
      if (type === 'following' && currentUser?.following?.length) {
        query = query.where('userId', 'in', currentUser.following);
      } else if (type === 'profile' && userId) {
        query = query.where('userId', '==', userId).where('parent', '==', null);
      } else if (type === 'community' && communityId) {
        query = query.where('communityId', '==', communityId).where('parent', '==', null);
      } else {
        query = query.where('parent', '==', null);
      }
      feedUnsub = query.onSnapshot(async snapshot => {
        if (snapshot.empty && !feedContainer.children.length) {
          document.getElementById('feedEmptyMsg').style.display = 'block';
          return;
        }
        for (const change of snapshot.docChanges()) {
          if (change.type === 'added') {
            const postData = change.doc.data();
            const userData = await db.collection('users').doc(postData.userId).get();
            if (userData.exists) {
              await renderThread({ id: change.doc.id, ...postData }, userData.data(), 0, communityId);
            }
          } else if (change.type === 'modified') {
            const postDiv = feedContainer.querySelector(`[data-post-id="${change.doc.id}"]`);
            if (postDiv) {
              postDiv.remove();
              const postData = change.doc.data();
              const userData = await db.collection('users').doc(postData.userId).get();
              if (userData.exists) {
                await renderThread({ id: change.doc.id, ...postData }, userData.data(), 0, communityId);
              }
            }
          } else if (change.type === 'removed') {
            const postDiv = feedContainer.querySelector(`[data-post-id="${change.doc.id}"]`);
            if (postDiv) postDiv.remove();
          }
        }
      }, err => showError('Failed to load feed: ' + (err.message || 'Unknown error')));
    }

    async function showProfile(userId) {
      viewingProfileUserId = userId;
      feedContainer.innerHTML = '';
      backToFeedBtn.style.display = 'block';
      feedTitle.textContent = 'Profile';
      const userDoc = await db.collection('users').doc(userId).get();
      if (!userDoc.exists) return showError('User not found.');
      const userData = userDoc.data();
      profileCard.style.display = 'block';
      profileCard.innerHTML = `
        <div class="profile-banner">
          <img src="${userData.banner || 'https://via.placeholder.com/960x160'}" alt="Banner" />
        </div>
        <img class="profile-avatar" src="${userData.avatar || 'https://via.placeholder.com/104'}" alt="Avatar" />
        <div class="profile-body">
          <div class="profile-info">
            <h3 ${userData.isVerified ? 'class="blue-tick"' : ''}>${userData.displayName || 'Anonymous'}</h3>
            <div class="profile-handle">@${userData.handle || 'user'}</div>
            <div class="profile-bio">${userData.bio || ''}</div>
            <div class="profile-links">
              ${userData.links ? userData.links.split(',').map(link => `<a href="${link.trim()}" target="_blank">${link.trim()}</a>`).join(' ') : ''}
            </div>
            <div class="profile-meta">
              <span class="following-count">${userData.following?.length || 0} Following</span>
              <span class="followers-count">${userData.followers?.length || 0} Followers</span>
            </div>
            <div class="profile-joined">Joined ${new Date(userData.createdAt?.toDate() || Date.now()).toLocaleDateString()}</div>
          </div>
          ${currentUser?.uid === userId ? '<button class="profile-edit-btn">Edit Profile</button>' : `<button class="follow-btn" ${userData.followers?.includes(currentUser?.uid) ? 'followed' : ''}>${userData.followers?.includes(currentUser?.uid) ? 'Unfollow' : 'Follow'}</button>`}
          ${currentUser?.isAdmin ? `
            <button class="btn ${userData.isBanned ? 'primary' : 'danger'} admin-ban-btn" style="margin-left:8px;">${userData.isBanned ? 'Unban' : 'Ban'}</button>
            <button class="btn ${userData.isVerified ? 'danger' : 'primary'} admin-verify-btn" style="margin-left:8px;">${userData.isVerified ? 'Remove Verification' : 'Verify'}</button>
            <button class="btn ${userData.isAdmin ? 'danger' : 'primary'} admin-toggle-btn" style="margin-left:8px;">${userData.isAdmin ? 'Remove Admin' : 'Make Admin'}</button>
          ` : ''}
          ${userData.songs?.length ? `
            <div style="margin-top:16px;">
              <h4 style="font-weight:800;color:#0f172a;">Songs</h4>
              ${userData.songs.map(song => `
                <div style="margin:8px 0;">
                  <div>${song.title} (${song.genre})</div>
                  <audio src="${song.url}" controls></audio>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
      const followBtn = profileCard.querySelector('.follow-btn');
      if (followBtn) {
        followBtn.addEventListener('click', async () => {
          if (!currentUser) return showError('Please sign in to follow.');
          try {
            const userRef = db.collection('users').doc(currentUser.uid);
            const targetUserRef = db.collection('users').doc(userId);
            if (userData.followers?.includes(currentUser.uid)) {
              await userRef.update({ following: firebase.firestore.FieldValue.arrayRemove(userId) });
              await targetUserRef.update({ followers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
            } else {
              await userRef.update({ following: firebase.firestore.FieldValue.arrayUnion(userId) });
              await targetUserRef.update({ followers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
              if (userId !== currentUser.uid) {
                await db.collection('notifications').add({
                  userId,
                  type: 'follow',
                  fromUserId: currentUser.uid,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
            }
            firebase.analytics().logEvent('follow_user', { user_id: userId });
            showProfile(userId);
          } catch (e) {
            showError('Failed to follow/unfollow: ' + (e.message || 'Unknown error'));
          }
        });
      }
      const adminButtons = profileCard.querySelectorAll('.admin-ban-btn, .admin-verify-btn, .admin-toggle-btn');
      adminButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
          const userRef = db.collection('users').doc(userId);
          const user = await userRef.get();
          if (!user.exists) return;
          const userData = user.data();
          try {
            if (btn.classList.contains('admin-ban-btn')) {
              await userRef.update({ isBanned: !userData.isBanned });
              firebase.analytics().logEvent(userData.isBanned ? 'unban_user' : 'ban_user', { user_id: userId });
            } else if (btn.classList.contains('admin-verify-btn')) {
              await userRef.update({ isVerified: !userData.isVerified });
              firebase.analytics().logEvent(userData.isVerified ? 'remove_verification' : 'verify_user', { user_id: userId });
            } else if (btn.classList.contains('admin-toggle-btn')) {
              await userRef.update({ isAdmin: !userData.isAdmin });
              firebase.analytics().logEvent(userData.isAdmin ? 'remove_admin' : 'make_admin', { user_id: userId });
            }
            showProfile(userId);
          } catch (e) {
            showError('Failed to update user status: ' + (e.message || 'Unknown error'));
          }
        });
      });
      const editBtn = profileCard.querySelector('.profile-edit-btn');
      if (editBtn) {
        editBtn.addEventListener('click', () => {
          document.getElementById('editDisplayName').value = userData.displayName || '';
          document.getElementById('editHandle').value = userData.handle ? `@${userData.handle}` : '';
          document.getElementById('editBio').value = userData.bio || '';
          document.getElementById('editLinks').value = userData.links || '';
          document.getElementById('currentSongs').innerHTML = userData.songs?.map(song => `
            <div style="margin:8px 0;">
              ${song.title} (${song.genre}) <button class="btn danger delete-song-btn" data-song-id="${song.id}">Delete</button>
            </div>
          `).join('') || '';
          document.getElementById('songInput').value = '';
          document.getElementById('songTitle').value = '';
          document.getElementById('songGenre').value = '';
          profileCard.style.display = 'none';
          profileEditCard.style.display = 'block';
        });
      }
      startFeedListener('profile', userId);
    }

    async function searchContent() {
      const query = document.getElementById('searchBar').value.trim();
      const searchResults = document.getElementById('searchResults');
      searchResults.innerHTML = '';
      if (!query) return;
      if (query.startsWith('@')) {
        const handle = query.slice(1).toLowerCase();
        const usersSnapshot = await db.collection('users').where('handle', '>=', handle).where('handle', '<=', handle + '\uf8ff').get();
        usersSnapshot.forEach(doc => {
          const user = doc.data();
          searchResults.innerHTML += `
            <div style="padding:8px 0;cursor:pointer;" data-user-id="${doc.id}">
              <strong ${user.isVerified ? 'class="blue-tick"' : ''}>${user.displayName || 'Anonymous'}</strong>
              <span class="profile-handle">@${user.handle || 'user'}</span>
            </div>
          `;
        });
        searchResults.querySelectorAll('div').forEach(div => div.addEventListener('click', () => showProfile(div.dataset.userId)));
      } else if (query.startsWith('#')) {
        const tag = query.slice(1).toLowerCase();
        const postsSnapshot = await db.collection('posts').where('hashtags', 'array-contains', tag).orderBy('createdAt', 'desc').limit(10).get();
        feedContainer.innerHTML = '';
        if (postsSnapshot.empty) {
          document.getElementById('feedEmptyMsg').style.display = 'block';
          return;
        }
        for (const doc of postsSnapshot.docs) {
          const postData = doc.data();
          const userData = await db.collection('users').doc(postData.userId).get();
          if (userData.exists) {
            await renderThread({ id: doc.id, ...postData }, userData.data());
          }
        }
      }
    }

    async function renderNotifications() {
      if (!currentUser) return;
      feedContainer.innerHTML = '';
      notificationsCard.style.display = 'block';
      feedTitle.textContent = 'Notifications';
      backToFeedBtn.style.display = 'block';
      const notificationsContent = document.getElementById('notificationsContent');
      notificationsContent.innerHTML = '';
      const snapshot = await db.collection('notifications').where('userId', '==', currentUser.uid).orderBy('createdAt', 'desc').limit(20).get();
      if (snapshot.empty) {
        notificationsContent.innerHTML = '<div style="text-align:center;color:#94a3b8;">No notifications yet.</div>';
        return;
      }
      for (const doc of snapshot.docs) {
        const notif = doc.data();
        const fromUser = await db.collection('users').doc(notif.fromUserId).get();
        if (fromUser.exists) {
          const fromUserData = fromUser.data();
          let message = '';
          if (notif.type === 'like') message = `@${fromUserData.handle} liked your post.`;
          else if (notif.type === 'repost') message = `@${fromUserData.handle} reposted your post.`;
          else if (notif.type === 'follow') message = `@${fromUserData.handle} followed you.`;
          else if (notif.type === 'comment') message = `@${fromUserData.handle} commented on your post.`;
          else if (notif.type === 'quote') message = `@${fromUserData.handle} quoted your post.`;
          notificationsContent.innerHTML += `
            <div style="padding:8px 0;cursor:pointer;" data-post-id="${notif.postId || ''}" data-user-id="${notif.fromUserId}">
              <strong ${fromUserData.isVerified ? 'class="blue-tick"' : ''}>${fromUserData.displayName || 'Anonymous'}</strong>
              <span class="profile-handle">@${fromUserData.handle || 'user'}</span>
              <div>${message}</div>
            </div>
          `;
        }
      }
      notificationsContent.querySelectorAll('div').forEach(div => {
        div.addEventListener('click', () => {
          if (div.dataset.postId) showPost(div.dataset.postId);
          else showProfile(div.dataset.userId);
        });
      });
    }

    async function showPost(postId) {
      feedContainer.innerHTML = '';
      backToFeedBtn.style.display = 'block';
      feedTitle.textContent = 'Thread';
      const postDoc = await db.collection('posts').doc(postId).get();
      if (!postDoc.exists) return showError('Post not found.');
      const postData = postDoc.data();
      const userData = await db.collection('users').doc(postData.userId).get();
      if (userData.exists) {
        await renderThread({ id: postId, ...postData }, userData.data());
      }
    }

    async function renderCommunities() {
      if (!currentUser) return;
      communityCard.style.display = 'block';
      const snapshot = await db.collection('communities').get();
      communityList.innerHTML = '';
      if (snapshot.empty) {
        communityList.innerHTML = '<div style="text-align:center;color:#94a3b8;">No communities available.</div>';
        return;
      }
      for (const doc of snapshot.docs) {
        const community = doc.data();
        const isMember = community.members?.includes(currentUser.uid);
        communityList.innerHTML += `
          <div style="padding:8px 0;cursor:pointer;" data-community-id="${doc.id}">
            <strong>${community.name}</strong>
            <div>${community.description}</div>
            <button class="btn primary join-community-btn" data-community-id="${doc.id}" style="float:right;margin-top:-24px;">${isMember ? 'Leave' : 'Join'}</button>
          </div>
        `;
      }
      communityList.querySelectorAll('.join-community-btn').forEach(btn => {
        btn.addEventListener('click', async e => {
          e.stopPropagation();
          const communityId = btn.dataset.communityId;
          const communityRef = db.collection('communities').doc(communityId);
          const community = await communityRef.get();
          if (!community.exists) return;
          const members = community.data().members || [];
          if (members.includes(currentUser.uid)) {
            await communityRef.update({ members: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
            btn.textContent = 'Join';
          } else {
            await communityRef.update({ members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
            btn.textContent = 'Leave';
          }
          firebase.analytics().logEvent(members.includes(currentUser.uid) ? 'leave_community' : 'join_community', { community_id: communityId });
        });
      });
      communityList.querySelectorAll('div').forEach(div => {
        div.addEventListener('click', () => {
          startFeedListener('community', null, div.dataset.communityId);
          feedTitle.textContent = 'Community';
          backToFeedBtn.style.display = 'block';
        });
      });
    }

    async function renderSuggestedUsers() {
      if (!currentUser) return;
      suggestedUsersCard.style.display = 'block';
      const suggestedUsersCardContent = document.getElementById('suggestedUsersCard');
      suggestedUsersCardContent.innerHTML = '<h4 style="margin:0 0 12px 0;font-weight:800;color:#0f172a;">Suggested Users</h4>';
      const usersSnapshot = await db.collection('users').orderBy('followers', 'desc').limit(5).get();
      if (usersSnapshot.empty) {
        suggestedUsersCardContent.innerHTML += '<div style="text-align:center;color:#94a3b8;">No users to suggest.</div>';
        return;
      }
      for (const doc of usersSnapshot.docs) {
        const user = doc.data();
        if (user.uid === currentUser.uid) continue;
        suggestedUsersCardContent.innerHTML += `
          <div style="padding:8px 0;cursor:pointer;" data-user-id="${doc.id}">
            <strong ${user.isVerified ? 'class="blue-tick"' : ''}>${user.displayName || 'Anonymous'}</strong>
            <span class="profile-handle">@${user.handle || 'user'}</span>
            <button class="btn primary follow-suggested-btn" style="float:right;margin-top:-24px;" data-user-id="${doc.id}" ${user.followers?.includes(currentUser.uid) ? 'followed' : ''}>
              ${user.followers?.includes(currentUser.uid) ? 'Unfollow' : 'Follow'}
            </button>
          </div>
        `;
      }
      suggestedUsersCardContent.querySelectorAll('.follow-suggested-btn').forEach(btn => {
        btn.addEventListener('click', async e => {
          e.stopPropagation();
          const userId = btn.dataset.userId;
          try {
            const userRef = db.collection('users').doc(currentUser.uid);
            const targetUserRef = db.collection('users').doc(userId);
            const targetUser = await targetUserRef.get();
            if (!targetUser.exists) return;
            const followers = targetUser.data().followers || [];
            if (followers.includes(currentUser.uid)) {
              await userRef.update({ following: firebase.firestore.FieldValue.arrayRemove(userId) });
              await targetUserRef.update({ followers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
              btn.textContent = 'Follow';
              btn.removeAttribute('followed');
            } else {
              await userRef.update({ following: firebase.firestore.FieldValue.arrayUnion(userId) });
              await targetUserRef.update({ followers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
              btn.textContent = 'Unfollow';
              btn.setAttribute('followed', '');
              if (userId !== currentUser.uid) {
                await db.collection('notifications').add({
                  userId,
                  type: 'follow',
                  fromUserId: currentUser.uid,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
            }
            firebase.analytics().logEvent(followers.includes(currentUser.uid) ? 'unfollow_user' : 'follow_user', { user_id: userId });
          } catch (e) {
            showError('Failed to follow/unfollow: ' + (e.message || 'Unknown error'));
          }
        });
      });
      suggestedUsersCardContent.querySelectorAll('div').forEach(div => {
        div.addEventListener('click', () => showProfile(div.dataset.userId));
      });
    }

    async function renderTrendingHashtags() {
      const snapshot = await db.collection('posts').orderBy('createdAt', 'desc').limit(100).get();
      const hashtagCount = {};
      snapshot.forEach(doc => {
        const hashtags = doc.data().hashtags || [];
        hashtags.forEach(tag => {
          hashtagCount[tag] = (hashtagCount[tag] || 0) + 1;
        });
      });
      const trendingHashtags = Object.entries(hashtagCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
      const trendingHashtagsCard = document.getElementById('trendingHashtagsCard');
      trendingHashtagsCard.innerHTML = '';
      if (!trendingHashtags.length) {
        trendingHashtagsCard.innerHTML = '<div style="text-align:center;color:#94a3b8;">No trending hashtags.</div>';
        return;
      }
      trendingHashtags.forEach(([tag, count]) => {
        trendingHashtagsCard.innerHTML += `
          <div style="padding:8px 0;cursor:pointer;">
            <a href="#" class="hashtag" data-tag="${tag}">#${tag}</a>
            <span style="color:#6b7280;">${count} posts</span>
          </div>
        `;
      });
      trendingHashtagsCard.querySelectorAll('.hashtag').forEach(tag => {
        tag.addEventListener('click', e => {
          e.preventDefault();
          document.getElementById('searchBar').value = `#${tag.dataset.tag}`;
          searchContent();
        });
      });
    }

    async function renderTrendingMedia() {
      trendingMediaCard.style.display = 'block';
      const trendingMediaContent = document.getElementById('trendingMediaContent');
      trendingMediaContent.innerHTML = '';
      const snapshot = await db.collection('posts').where('media', '!=', []).orderBy('likes', 'desc').orderBy('createdAt', 'desc').limit(5).get();
      if (snapshot.empty) {
        trendingMediaContent.innerHTML = '<div style="text-align:center;color:#94a3b8;">No trending media.</div>';
        return;
      }
      for (const doc of snapshot.docs) {
        const post = doc.data();
        const user = await db.collection('users').doc(post.userId).get();
        if (!user.exists) continue;
        const userData = user.data();
        let mediaHtml = '';
        post.media.forEach(media => {
          if (media.type.startsWith('image/')) {
            mediaHtml += `<img src="${media.url}" alt="Trending media" style="max-width:72px;max-height:72px;border-radius:12px;margin:4px;" />`;
          } else if (media.type.startsWith('video/')) {
            mediaHtml += `<video src="${media.url}" controls style="max-width:72px;max-height:72px;border-radius:12px;margin:4px;"></video>`;
          } else if (media.type.startsWith('audio/')) {
            mediaHtml += `<audio src="${media.url}" controls style="width:100%;margin:4px;"></audio>`;
          }
        });
        trendingMediaContent.innerHTML += `
          <div style="padding:8px 0;cursor:pointer;" data-post-id="${doc.id}">
            <strong ${userData.isVerified ? 'class="blue-tick"' : ''}>${userData.displayName || 'Anonymous'}</strong>
            <span class="profile-handle">@${userData.handle || 'user'}</span>
            <div style="margin:8px 0;">${formatContent(post.content.slice(0, 50) + (post.content.length > 50 ? '...' : ''))}</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">${mediaHtml}</div>
          </div>
        `;
      }
      trendingMediaContent.querySelectorAll('div').forEach(div => {
        div.addEventListener('click', () => showPost(div.dataset.postId));
      });
    }

    async function renderAdminPanel() {
      const adminUserResults = document.getElementById('adminUserResults');
      const adminPostList = document.getElementById('adminPostList');
      adminUserResults.innerHTML = '';
      adminPostList.innerHTML = '';
      const postsSnapshot = await db.collection('posts').orderBy('createdAt', 'desc').limit(10).get();
      for (const doc of postsSnapshot.docs) {
        const post = doc.data();
        const user = await db.collection('users').doc(post.userId).get();
        if (!user.exists) continue;
        const userData = user.data();
        adminPostList.innerHTML += `
          <div style="padding:8px 0;">
            <strong ${userData.isVerified ? 'class="blue-tick"' : ''}>${userData.displayName || 'Anonymous'}</strong>
            <span class="profile-handle">@${userData.handle || 'user'}</span>
            <div style="margin:8px 0;">${formatContent(post.content.slice(0, 50) + (post.content.length > 50 ? '...' : ''))}</div>
                        <button class="btn danger admin-delete-post" data-post-id="${doc.id}">Delete Post</button>
          </div>
        `;
      }
      adminPostList.querySelectorAll('.admin-delete-post').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (confirm('Delete this post?')) {
            try {
              const postRef = db.collection('posts').doc(btn.dataset.postId);
              const post = await postRef.get();
              if (post.exists && post.data().media?.length) {
                for (const media of post.data().media) {
                  await deleteFromDrive(media.id);
                }
              }
              await postRef.delete();
              firebase.analytics().logEvent('admin_delete_post', { post_id: btn.dataset.postId });
              renderAdminPanel();
            } catch (e) {
              showError('Failed to delete post: ' + (e.message || 'Unknown error'));
            }
          }
        });
      });
      document.getElementById('adminSearchBtn').addEventListener('click', async () => {
        const query = document.getElementById('adminSearchUser').value.trim().slice(1).toLowerCase();
        adminUserResults.innerHTML = '';
        if (!query) return;
        const usersSnapshot = await db.collection('users').where('handle', '>=', query).where('handle', '<=', query + '\uf8ff').get();
        usersSnapshot.forEach(doc => {
          const user = doc.data();
          adminUserResults.innerHTML += `
            <div style="padding:8px 0;">
              <strong ${user.isVerified ? 'class="blue-tick"' : ''}>${user.displayName || 'Anonymous'}</strong>
              <span class="profile-handle">@${user.handle || 'user'}</span>
              <button class="btn ${user.isBanned ? 'primary' : 'danger'} admin-ban-btn" data-user-id="${doc.id}">${user.isBanned ? 'Unban' : 'Ban'}</button>
              <button class="btn ${user.isVerified ? 'danger' : 'primary'} admin-verify-btn" data-user-id="${doc.id}">${user.isVerified ? 'Remove Verification' : 'Verify'}</button>
              <button class="btn ${user.isAdmin ? 'danger' : 'primary'} admin-toggle-btn" data-user-id="${doc.id}">${user.isAdmin ? 'Remove Admin' : 'Make Admin'}</button>
            </div>
          `;
        });
        adminUserResults.querySelectorAll('.admin-ban-btn, .admin-verify-btn, .admin-toggle-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const userId = btn.dataset.userId;
            const userRef = db.collection('users').doc(userId);
            const user = await userRef.get();
            if (!user.exists) return;
            const userData = user.data();
            try {
              if (btn.classList.contains('admin-ban-btn')) {
                await userRef.update({ isBanned: !userData.isBanned });
                firebase.analytics().logEvent(userData.isBanned ? 'unban_user' : 'ban_user', { user_id: userId });
              } else if (btn.classList.contains('admin-verify-btn')) {
                await userRef.update({ isVerified: !userData.isVerified });
                firebase.analytics().logEvent(userData.isVerified ? 'remove_verification' : 'verify_user', { user_id: userId });
              } else if (btn.classList.contains('admin-toggle-btn')) {
                await userRef.update({ isAdmin: !userData.isAdmin });
                firebase.analytics().logEvent(userData.isAdmin ? 'remove_admin' : 'make_admin', { user_id: userId });
              }
              renderAdminPanel();
            } catch (e) {
              showError('Failed to update user status: ' + (e.message || 'Unknown error'));
            }
          });
        });
      });
    }

    auth.onAuthStateChanged(async user => {
      if (user) {
        try {
          await loadGapi();
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (!userDoc.exists) {
            const handle = user.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, '').slice(0, 15);
            await db.collection('users').doc(user.uid).set({
              uid: user.uid,
              displayName: user.displayName || 'Anonymous',
              handle: handle.toLowerCase(),
              email: user.email,
              avatar: user.photoURL || '',
              banner: '',
              bio: '',
              links: '',
              followers: [],
              following: [],
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              isBanned: false,
              isVerified: false,
              isAdmin: false,
              songs: []
            });
            firebase.analytics().logEvent('sign_up', { user_id: user.uid });
          }
          const userData = await db.collection('users').doc(user.uid).get();
          currentUser = { ...userData.data(), uid: user.uid };
          signInBtn.style.display = 'none';
          signOutBtn.style.display = 'block';
          postWidget.style.display = 'block';
          profileBtn.style.display = 'block';
          notificationsBtn.style.display = 'block';
          welcomeMsg.textContent = `Welcome, @${currentUser.handle || 'user'}!`;
          if (currentUser.isAdmin) adminPanelBtn.style.display = 'block';
          await renderSuggestedUsers();
          await renderCommunities();
          await renderTrendingHashtags();
          await renderTrendingMedia();
          startFeedListener('forYou');
        } catch (e) {
          showError('Failed to initialize user: ' + (e.message || 'Unknown error'));
        }
      } else {
        currentUser = null;
        signInBtn.style.display = 'block';
        signOutBtn.style.display = 'none';
        postWidget.style.display = 'none';
        profileCard.style.display = 'none';
        profileEditCard.style.display = 'none';
        adminPanelBtn.style.display = 'none';
        adminPanel.style.display = 'none';
        notificationsBtn.style.display = 'none';
        notificationsCard.style.display = 'none';
        communityCard.style.display = 'none';
        suggestedUsersCard.style.display = 'none';
        welcomeMsg.textContent = 'Sign in to join the conversation!';
        if (feedUnsub) feedUnsub();
        startFeedListener('forYou');
        renderTrendingHashtags();
        renderTrendingMedia();
      }
    });

    signInBtn.addEventListener('click', () => {
      auth.signInWithPopup(provider).catch(e => showError('Sign-in failed: ' + (e.message || 'Unknown error')));
    });

    signOutBtn.addEventListener('click', () => {
      auth.signOut().catch(e => showError('Sign-out failed: ' + (e.message || 'Unknown error')));
    });

    blogContent.addEventListener('input', () => updateCharCount(blogContent, charCount));

    mediaInput.addEventListener('change', () => {
      mediaPreview.innerHTML = '';
      Array.from(mediaInput.files).forEach(file => {
        const url = URL.createObjectURL(file);
        let element;
        if (file.type.startsWith('image/')) element = document.createElement('img');
        else if (file.type.startsWith('video/')) { element = document.createElement('video'); element.controls = true; }
        else if (file.type.startsWith('audio/')) { element = document.createElement('audio'); element.controls = true; }
        element.src = url;
        mediaPreview.appendChild(element);
      });
    });

    document.getElementById('postBlogBtn').addEventListener('click', async () => {
      if (!currentUser || !currentUser.uid) return showError('Please sign in to post.');
      const content = blogContent.value.trim();
      if (!content && !mediaInput.files.length) return showError('Post cannot be empty.');
      try {
        const mediaUrls = [];
        for (const file of mediaInput.files) {
          const fileName = `${Date.now()}_${file.name}`;
          const uploadResult = await uploadToDrive(file, fileName, currentUser.uid);
          mediaUrls.push({ url: uploadResult.url, id: uploadResult.id, type: file.type });
        }
        let quotePostId = null;
        const quoteMatch = content.match(/\[Quote Post ID: (\w+)\]/);
        if (quoteMatch) {
          quotePostId = quoteMatch[1];
          const quotedPost = await db.collection('posts').doc(quotePostId).get();
          if (quotedPost.exists && quotedPost.data().userId !== currentUser.uid) {
            await db.collection('notifications').add({
              userId: quotedPost.data().userId,
              type: 'quote',
              postId: quotePostId,
              fromUserId: currentUser.uid,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }
        const postData = {
          content,
          media: mediaUrls,
          userId: currentUser.uid,
          userHandle: currentUser.handle,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          parent: null,
          replyTo: null,
          likes: [],
          reposts: [],
          hashtags: content.match(/(^|\s)#(\w+)/g)?.map(tag => tag.trim().slice(1).toLowerCase()) || [],
          quotePostId,
          communityId: currentCommunityId
        };
        await db.collection('posts').add(postData);
        blogContent.value = '';
        mediaInput.value = '';
        mediaPreview.innerHTML = '';
        updateCharCount(blogContent, charCount);
        firebase.analytics().logEvent('create_post', { has_media: mediaUrls.length > 0 });
      } catch (e) {
        showError('Failed to post: ' + (e.message || 'Unknown error'));
      }
    });

    document.getElementById('forYouFeedBtn').addEventListener('click', () => {
      startFeedListener('forYou');
      feedTitle.textContent = 'For You';
      backToFeedBtn.style.display = 'none';
      profileCard.style.display = 'none';
      profileEditCard.style.display = 'none';
      notificationsCard.style.display = 'none';
      adminPanel.style.display = 'none';
      document.getElementById('forYouFeedBtn').classList.add('primary');
      document.getElementById('followingFeedBtn').classList.remove('primary');
      document.getElementById('profileBtn').classList.remove('primary');
      document.getElementById('notificationsBtn').classList.remove('primary');
      document.getElementById('adminPanelBtn').classList.remove('primary');
    });

    document.getElementById('followingFeedBtn').addEventListener('click', () => {
      if (!currentUser) return showError('Please sign in to view following feed.');
      startFeedListener('following');
      feedTitle.textContent = 'Following';
      backToFeedBtn.style.display = 'none';
      profileCard.style.display = 'none';
      profileEditCard.style.display = 'none';
      notificationsCard.style.display = 'none';
      adminPanel.style.display = 'none';
      document.getElementById('forYouFeedBtn').classList.remove('primary');
      document.getElementById('followingFeedBtn').classList.add('primary');
      document.getElementById('profileBtn').classList.remove('primary');
      document.getElementById('notificationsBtn').classList.remove('primary');
      document.getElementById('adminPanelBtn').classList.remove('primary');
    });

    profileBtn.addEventListener('click', () => {
      if (!currentUser) return showError('Please sign in to view your profile.');
      showProfile(currentUser.uid);
      document.getElementById('forYouFeedBtn').classList.remove('primary');
      document.getElementById('followingFeedBtn').classList.remove('primary');
      document.getElementById('profileBtn').classList.add('primary');
      document.getElementById('notificationsBtn').classList.remove('primary');
      document.getElementById('adminPanelBtn').classList.remove('primary');
    });

    notificationsBtn.addEventListener('click', () => {
      if (!currentUser) return showError('Please sign in to view notifications.');
      renderNotifications();
      document.getElementById('forYouFeedBtn').classList.remove('primary');
      document.getElementById('followingFeedBtn').classList.remove('primary');
      document.getElementById('profileBtn').classList.remove('primary');
      document.getElementById('notificationsBtn').classList.add('primary');
      document.getElementById('adminPanelBtn').classList.remove('primary');
    });

    adminPanelBtn.addEventListener('click', () => {
      if (!currentUser?.isAdmin) return showError('Admin access required.');
      adminPanel.style.display = 'block';
      profileCard.style.display = 'none';
      profileEditCard.style.display = 'none';
      notificationsCard.style.display = 'none';
      feedContainer.innerHTML = '';
      feedTitle.textContent = 'Admin Panel';
      backToFeedBtn.style.display = 'block';
      renderAdminPanel();
      document.getElementById('forYouFeedBtn').classList.remove('primary');
      document.getElementById('followingFeedBtn').classList.remove('primary');
      document.getElementById('profileBtn').classList.remove('primary');
      document.getElementById('notificationsBtn').classList.remove('primary');
      document.getElementById('adminPanelBtn').classList.add('primary');
    });

    backToFeedBtn.addEventListener('click', () => {
      startFeedListener('forYou');
      feedTitle.textContent = 'For You';
      backToFeedBtn.style.display = 'none';
      profileCard.style.display = 'none';
      profileEditCard.style.display = 'none';
      notificationsCard.style.display = 'none';
      adminPanel.style.display = 'none';
      document.getElementById('forYouFeedBtn').classList.add('primary');
      document.getElementById('followingFeedBtn').classList.remove('primary');
      document.getElementById('profileBtn').classList.remove('primary');
      document.getElementById('notificationsBtn').classList.remove('primary');
      document.getElementById('adminPanelBtn').classList.remove('primary');
    });

    document.getElementById('searchBar').addEventListener('input', debounce(searchContent, 300));

    document.getElementById('saveProfileBtn').addEventListener('click', async () => {
      if (!currentUser) return showError('Please sign in to edit profile.');
      const displayName = document.getElementById('editDisplayName').value.trim();
      let handle = document.getElementById('editHandle').value.trim().replace(/^@/, '');
      const bio = document.getElementById('editBio').value.trim();
      const links = document.getElementById('editLinks').value.trim();
      const avatarInput = document.getElementById('editAvatarInput');
      const bannerInput = document.getElementById('editBannerInput');
      const songInput = document.getElementById('songInput');
      const songTitle = document.getElementById('songTitle').value.trim();
      const songGenre = document.getElementById('songGenre').value;
      if (!displayName || !handle) return showError('Display name and handle are required.');
      if (handle.length < 3 || handle.length > 15 || !/^[a-zA-Z0-9]+$/.test(handle)) {
        return showError('Handle must be 3-15 alphanumeric characters.');
      }
      try {
        const existingHandle = await db.collection('users').where('handle', '==', handle.toLowerCase()).get();
        if (!existingHandle.empty && existingHandle.docs[0].id !== currentUser.uid) {
          return showError('Handle already taken.');
        }
        const updates = {
          displayName,
          handle: handle.toLowerCase(),
          bio,
          links,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (avatarInput.files[0]) {
          const fileName = `${Date.now()}_${avatarInput.files[0].name}`;
          const uploadResult = await uploadToDrive(avatarInput.files[0], fileName, currentUser.uid);
          updates.avatar = uploadResult.url;
          if (currentUser.avatarId) await deleteFromDrive(currentUser.avatarId);
          updates.avatarId = uploadResult.id;
        }
        if (bannerInput.files[0]) {
          const fileName = `${Date.now()}_${bannerInput.files[0].name}`;
          const uploadResult = await uploadToDrive(bannerInput.files[0], fileName, currentUser.uid);
          updates.banner = uploadResult.url;
          if (currentUser.bannerId) await deleteFromDrive(currentUser.bannerId);
          updates.bannerId = uploadResult.id;
        }
        if (songInput.files[0] && songTitle && songGenre) {
          const userDoc = await db.collection('users').doc(currentUser.uid).get();
          const songs = userDoc.data().songs || [];
          if (songs.length >= 5) return showError('Maximum 5 songs allowed.');
          const fileName = `${Date.now()}_${songInput.files[0].name}`;
          const uploadResult = await uploadToDrive(songInput.files[0], fileName, currentUser.uid);
          songs.push({ url: uploadResult.url, id: uploadResult.id, title: songTitle, genre: songGenre });
          updates.songs = songs;
        }
        await db.collection('users').doc(currentUser.uid).update(updates);
        profileEditCard.style.display = 'none';
        showProfile(currentUser.uid);
        firebase.analytics().logEvent('update_profile', { user_id: currentUser.uid });
      } catch (e) {
        showError('Failed to update profile: ' + (e.message || 'Unknown error'));
      }
    });

    document.getElementById('cancelProfileEdit').addEventListener('click', () => {
      profileEditCard.style.display = 'none';
      showProfile(currentUser.uid);
    });

    document.getElementById('currentSongs').addEventListener('click', async e => {
      if (e.target.classList.contains('delete-song-btn')) {
        if (confirm('Delete this song?')) {
          try {
            const songId = e.target.dataset.songId;
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const songs = userDoc.data().songs || [];
            const updatedSongs = songs.filter(song => song.id !== songId);
            await deleteFromDrive(songId);
            await db.collection('users').doc(currentUser.uid).update({ songs: updatedSongs });
            document.getElementById('currentSongs').innerHTML = updatedSongs.map(song => `
              <div style="margin:8px 0;">
                ${song.title} (${song.genre}) <button class="btn danger delete-song-btn" data-song-id="${song.id}">Delete</button>
              </div>
            `).join('');
            firebase.analytics().logEvent('delete_song', { song_id: songId });
          } catch (e) {
            showError('Failed to delete song: ' + (e.message || 'Unknown error'));
          }
        }
      }
    });

    createCommunityBtn.addEventListener('click', async () => {
      if (!currentUser) return showError('Please sign in to create a community.');
      const name = prompt('Enter community name (max 50 characters):');
      if (!name || name.length > 50) return showError('Invalid community name.');
      const description = prompt('Enter community description (max 160 characters):');
      if (!description || description.length > 160) return showError('Invalid description.');
      try {
        await db.collection('communities').add({
          name,
          description,
          creatorId: currentUser.uid,
          members: [currentUser.uid],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        renderCommunities();
        firebase.analytics().logEvent('create_community', { community_name: name });
      } catch (e) {
        showError('Failed to create community: ' + (e.message || 'Unknown error'));
      }
    });

    // Initialize trending content on load
    renderTrendingHashtags();
    renderTrendingMedia();
  </script>

</!doctype>
